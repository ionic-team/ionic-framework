<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <title>Picker Column - Dynamic Options</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link href="../../../../../css/core.css" rel="stylesheet" />
    <link href="../../../../../scripts/testing/styles.css" rel="stylesheet" />
    <script src="../../../../../scripts/testing/scripts.js"></script>
    <script nomodule src="../../../../../dist/ionic/ionic.js"></script>
    <script type="module" src="../../../../../dist/ionic/ionic.esm.js"></script>
    <style>
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        grid-row-gap: 20px;
        grid-column-gap: 20px;
      }
      h2 {
        font-size: 12px;
        font-weight: normal;

        color: #6f7378;

        margin-top: 10px;
        margin-left: 5px;
      }
    </style>
  </head>
  <script type="module">
    import { pickerController } from '../../../../dist/ionic/index.esm.js';
    window.pickerController = pickerController;
  </script>

  <body>
    <div class="grid ion-padding">
      <div class="grid-item">
        <h2>Single Column</h2>
        <ion-button onclick="removeOption()" id="single-column-remove-button">Remove Option</ion-button>
        <ion-button onclick="addOption()" id="single-column-add-button">Add Option</ion-button>
      </div>
      <div class="grid-item">
        <h2>Multiple Columns</h2>
        <ion-button onclick="removeOption(2, 5, multiColumnOptions)" id="multiple-column-remove-button"
          >Remove Option</ion-button
        >
        <ion-button onclick="addOption(2, 5, multiColumnOptions)" id="multiple-column-add-button"
          >Add Option</ion-button
        >
      </div>
    </div>
    <script>
      const defaultColumnOptions = [['Dog', 'Cat', 'Bird', 'Lizard', 'Chinchilla']];

      const multiColumnOptions = [
        ['Minified', 'Responsive', 'Full Stack', 'Mobile First', 'Serverless'],
        ['Tomato', 'Avocado', 'Onion', 'Potato', 'Artichoke'],
      ];

      async function removeOption(numColumns = 1, numOptions = 5, columnOptions = defaultColumnOptions) {
        const picker = await pickerController.create({
          columns: this.getColumns(numColumns, numOptions, columnOptions),
          buttons: this.getButtons(),
        });

        // Selecting the first column's second option will remove the second column's first option
        picker.addEventListener('ionPickerColChange', async (event) => {
          const newCols = JSON.parse(JSON.stringify(picker.columns));
          const selectedIndex = event.detail.selectedIndex;
          const column = event.detail.options[selectedIndex];

          // The first column was selected
          if (event.detail.name === 'col-0') {
            // The last option was selected
            if (column.value === 4) {
              const columnIndex = numColumns - 1;
              // Remove the first from the second column
              const filteredOptions = newCols[columnIndex].options.filter((o) => o.value !== 0);
              if (filteredOptions.length === newCols[columnIndex].options.length) {
                return;
              }
              newCols[columnIndex].options = filteredOptions;
              // Update the picker with the new options
              picker.columns = newCols;
            }
          }
        });

        await picker.present();
      }

      async function addOption(numColumns = 1, numOptions = 5, columnOptions = defaultColumnOptions) {
        const picker = await pickerController.create({
          columns: this.getColumns(numColumns, numOptions, columnOptions),
          buttons: this.getButtons(),
        });

        // Selecting the first column's second option will add an option to the second column
        picker.addEventListener('ionPickerColChange', async (event) => {
          const newCols = JSON.parse(JSON.stringify(picker.columns));
          const selectedIndex = event.detail.selectedIndex;
          const column = event.detail.options[selectedIndex];

          // The first column was selected
          if (event.detail.name === 'col-0') {
            const columnIndex = numColumns - 1;
            // The first option was selected
            if (column.value === 1) {
              const foundOption = newCols[columnIndex].options.find((o) => o.value === 'Carrot');
              if (foundOption) {
                return;
              }
              newCols[columnIndex].options.push({
                text: 'Carrot',
                value: 'Carrot',
              });
              // Update the picker with the new options
              picker.columns = newCols;
            }
          }
        });

        await picker.present();
      }

      function getButtons() {
        return [
          {
            text: 'Cancel',
            role: 'cancel',
          },
          {
            text: 'Confirm',
            handler: (value) => {
              console.log('Got Value', value);
            },
          },
        ];
      }

      function getColumns(numColumns, numOptions, columnOptions) {
        let columns = [];
        for (let i = 0; i < numColumns; i++) {
          columns.push({
            name: `col-${i}`,
            options: this.getColumnOptions(i, numOptions, columnOptions),
          });
        }

        return columns;
      }

      function getColumnOptions(columnIndex, numOptions, columnOptions) {
        let options = [];
        for (let i = 0; i < numOptions; i++) {
          options.push({
            text: columnOptions[columnIndex][i % numOptions],
            value: i,
          });
        }

        return options;
      }
    </script>
  </body>
</html>
