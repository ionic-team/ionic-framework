name: 'Ionic Nightly Build'

on:
  workflow_call:

permissions:
  contents: read
  id-token: write

jobs:
  create-nightly-hash:
    runs-on: ubuntu-latest
    outputs:
      nightly-hash: ${{ steps.create-nightly-hash.outputs.NIGHTLY_HASH }}
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      # A 1 is required before the timestamp
      # as lerna will fail when there is a leading 0
      # See https://github.com/lerna/lerna/issues/2840
      - name: Install Dependencies
        run: npm ci
        shell: bash
      - id: create-nightly-hash
        name: Create Nightly Hash
        # The date should output YYYYMMDD
        # so that it is human readable
        run: |
          echo "NIGHTLY_HASH=$(node ./.scripts/bump-version.js)-nightly.$(date +%Y%m%d)" >> $GITHUB_OUTPUT
        shell: bash

  release-ionic:
    needs: [create-nightly-hash]
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/release-ionic.yml
    secrets: inherit
    with:
      tag: nightly
      version: ${{ needs.create-nightly-hash.outputs.nightly-hash }}
